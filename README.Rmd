---
title: "Traitement des données issues du document partagé pour l'Annexe 4"
output: 
  github_document:
    df_print: kable
    toc: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Point du 24/07 sur les objectifs

**Objectif**: Définir des extractions pertinentes (indicateurs, Figures, tableaux) pour alimenter la rédaction du rapport

Travail au niveau Global UR / dans un second temps par axe.

Plusieurs volets à exploiter :

## Production de connaissances

- Articles (ACL ou non)
- Chapitres d'ouvrages

## Production "appliquée"
- Rapports scientifiques
- Vulgarisation
- Travail sur les partenaires économiques

## Production interdisciplinaire
- Travail sur les co-publications au sein de l'UR (réseau?) et catégorisation manuelle des disciplines de chaque agent.
- Travail sur les co-publications avec d'autres labos (les labos sont donc à catégoriser également)

> NB : Interdisciplinaire = SHS / SE / SPI

Objectif à court terme : Production d'indicateurs généraux, synthétiques pour chaque onglet du document excel.

**Envoi le 24/07 d'un dernier mail de rappel pour demander l'ajout d'articles qui seraient acceptés avec modifications mineures à ce jour (et seulement mineures) et rappel pour les derniers retardataires. Ajout d'une colonne 'révision' à cocher pour ces cas spécifiques. Cela concerne publications + ouvrages.**


# Import et nettoyage des données

## Import

Dans un premier temps, chargement des packages nécessaires :

```{r packages}
library(dplyr)
library(tidyr)
library(janitor)
library(ggplot2)
library(readxl)
library(purrr)
library(bib2df)

source("R/theme_inrae.R")
```

Nous pouvons maintenant importer le fichier :

```{r}
# Fichier en date du 24/07/2020
file <- "data/Annexe4_ETBX_complet_2020_07_24.xlsx"


# On réalise une boucle pour importer tous les onglets dans un seul objet, sous forme de liste

sheet_names <- readxl::excel_sheets(file) 
ANX4 <- list()

for (i in sheet_names[-1:-3]) {
  
  ANX4[[i]] <- readxl::read_excel(file, sheet  = i, skip = 1) %>%
    select(-1) # Retrait colonne n°
  
}

# On rend exploitables les noms d'onglets
names(ANX4) <- janitor::make_clean_names(names(ANX4))
```


Pour les tableaux avec cases à cocher, on définit une fonction de nettoyage qui permettra lors des synthèses de remplacer les `NA` par des `0` et les `x` par des `1`. Ainsi, nous pourrons faire des sommes etc.

```{r}
replace_cases <- function(x){
  
  value <- ifelse(is.na(x), yes = 0, no = 1)
  
  return(value)
  
}
```

## Vision d'ensemble du fichier

Voici un tableau récapitulatif de la dimension des onglets, triés selon le nombre de lignes.

```{r}
tab_dim <- tibble(
  Onglet = names(ANX4),
  nb_lignes = map_dbl(ANX4, nrow),
  nb_colonnes = map_dbl(ANX4, ncol)
) %>% 
  arrange(desc(nb_lignes))


# On ne va garder que les onglets qui ne sont pas vides. 
# Les onglets à 2 lignes sont à chaque fois vide (car la colonne n° a été remplie pour 1 et 2) 
# sauf pour 4 onglets particuliers qui sont ici rajoutés.
Onglets_non_empty <- tab_dim %>%
  filter(nb_lignes != 2) %>%
  pull(Onglet) %>% 
  c("ii_3_activ_consult","iii_1_elearning", "i_9_contrats_internationaux","i_1_articles_synth")

# On affiche le tableau
tab_dim %>% filter(Onglet %in% Onglets_non_empty)
```

# Exploitation des données

## Premiers indicateurs

### Projets

```{r out.width = "100%", fig.width = 13, fig.height = 10}

## Extraction des projets nationaux
projets_nationaux <- ANX4$i_9_contrats_nationaux %>% 
  clean_names() %>% 
  select(-x11) %>% 
  drop_na(contrat) %>% drop_na(date_debut) %>% mutate(type = "National")

## Projets européens
projets_europ <- ANX4$i_9_contrats_europ_autres %>% drop_na(`Date début`) %>% clean_names() %>%  
  mutate_at(vars(date_debut:date_fin), as.Date) %>% mutate(type = "Européen")

## Projets internationaux
projets_inter <- ANX4$i_9_contrats_internationaux %>% clean_names() %>%  
  mutate_at(vars(date_debut:date_fin), as.Date) %>% mutate(type = "International")

## Projets R&D
projets_rd <- ANX4$i_9_contrats_prive_r_d_indus %>% clean_names() %>%  
  mutate_at(vars(date_debut:date_fin), as.Date) %>% mutate(type = "R&D")

## Projets PIA
projets_pia <- ANX4$i_9_contrats_pia %>% clean_names() %>%  drop_na(contrat,date_debut) %>% 
  mutate_at(vars(date_debut:date_fin), as.Date) %>% mutate(type = "PIA")

## Projets de collectivités territoriales
projets_coll_terri <- ANX4$i_9_contrats_coll_territ %>% clean_names() %>%  drop_na(contrat,date_debut, date_fin) %>% 
  mutate_at(vars(date_debut), as.Date, origin = "1899-12-31") %>% mutate(type = "Collect. Ter.")

## On assemble le tout
PRJ <- bind_rows(projets_nationaux,projets_europ)%>%
  bind_rows(projets_inter) %>% 
  bind_rows(projets_rd) %>% 
  bind_rows(projets_pia) %>% 
  bind_rows(projets_coll_terri) %>% 
  mutate_at(vars(porteur:axe_3), replace_cases) %>% unique() %>% 
  mutate(date_fin = replace_na(date_fin, "2024-01-01")) %>%  # Il y a un projet international (le seul) à la fin inconnue... Donc par défaut j'ai décidé la fin en 2024 pour ne pas changer la tête du graphique tout en conservant l'info qu'il y a un projet international.
  mutate(porteur = recode(porteur, "0" = "ETBX Non porteur", "1"="ETBX Porteur")) %>% 
  mutate(porteur = factor(porteur, levels = c("ETBX Porteur", "ETBX Non porteur")))

## Production du graphique
ggplot(PRJ, aes(x = date_fin, y = contrat)) +
  geom_segment(aes(x = date_debut, xend = date_fin, y = contrat, yend = contrat, color = type), size = 4) +
  geom_point(fill = "black", shape = 23, color = "black", size = 4) +
  geom_point(aes(x = date_debut, y = contrat), color ="black", fill = "black", shape = 23, size = 4) +
  theme_inrae() +
  geom_vline(xintercept = as.Date("2020-06-01"), color = "blue", size = 4) +
  labs(x = "Temps", y = "Contrats", color = "Type") +
  facet_wrap(~porteur, scales = "free")
```

### Volet "Production de connaissances"

Problème rencontré : La saisie manuelle par les collègues sur le fichier excel ne permet pas d'effectuer de requêtes intéressantes... Il faut donc extraire manuellement auteur / date / revue sur des colonnes supplémentaires. Ci-dessous j'ai également tenté une approche via la base HALINRAE.

```{r}

# J'ai testé un export massif HAL-INRAE avec dates 2017-2020 et structure ETBX
test <- bib2df::bib2df("data/biball.bib")
```



## Vision pour chaque onglet

[TO-DO]
