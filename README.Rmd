---
title: "Traitement des données issues du document partagé pour l'Annexe 4"
output: 
  github_document:
    df_print: kable
    toc: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Point du 24/07 sur les objectifs

**Objectif**: Définir des extractions pertinentes (indicateurs, Figures, tableaux) pour alimenter la rédaction du rapport

Travail au niveau Global UR / dans un second temps par axe.

Plusieurs volets à exploiter :

- **Production de connaissances**

  - Articles (ACL ou non)
  - Chapitres d'ouvrages
  - Identification dans les revues

- **Production "appliquée"**

  - Rapports scientifiques
  - Vulgarisation
  - Travail sur les partenaires économiques

- **Partenariats**

  - Travail sur les co-publications au sein de l'UR (réseau?) et catégorisation manuelle des disciplines de chaque agent.
  - Travail sur les co-publications avec d'autres labos (les labos sont donc à catégoriser également)

> NB : Interdisciplinaire = SHS / SE / SPI

Objectif à court terme : Production d'indicateurs généraux, synthétiques pour chaque onglet du document excel.

**Envoi le 24/07 d'un dernier mail de rappel pour demander l'ajout d'articles qui seraient acceptés avec modifications mineures à ce jour (et seulement mineures) et rappel pour les derniers retardataires. Ajout d'une colonne 'révision' à cocher pour ces cas spécifiques. Cela concerne publications + ouvrages.**


# Import et nettoyage des données

## Import

Dans un premier temps, chargement des packages nécessaires :

```{r packages}
library(dplyr)
library(tidyr)
library(janitor)
library(ggplot2)
library(readxl)
library(purrr)
library(bib2df)
library(gt)
library(wordcloud2)
library(stringr)

source("R/theme_inrae.R")
```

Nous pouvons maintenant importer le fichier :

```{r}
# Fichier en date du 27/07/2020
file <- "data/Annexe4_ETBX_complet_2020_07_27.xlsx"


# On réalise une boucle pour importer tous les onglets dans un seul objet, sous forme de liste

sheet_names <- readxl::excel_sheets(file) 
ANX4 <- list()

for (i in sheet_names[-1:-3]) {
  
  ANX4[[i]] <- readxl::read_excel(file, sheet  = i, skip = 1) %>%
    select(-1) # Retrait colonne n°
  
}

# On rend exploitables les noms d'onglets
names(ANX4) <- janitor::make_clean_names(names(ANX4))
```


Pour les tableaux avec cases à cocher, on définit une fonction de nettoyage qui permettra lors des synthèses de remplacer les `NA` par des `0` et les `x` par des `1`. Ainsi, nous pourrons faire des sommes etc.

```{r}
replace_cases <- function(x){
  
  value <- ifelse(is.na(x), yes = 0, no = 1)
  
  return(value)
  
}
```

## Vision d'ensemble du fichier

Voici un tableau récapitulatif de la dimension des onglets, triés selon le nombre de lignes.

```{r}
tab_dim <- tibble(
  Onglet = names(ANX4),
  nb_lignes = map_dbl(ANX4, nrow),
  nb_colonnes = map_dbl(ANX4, ncol)
) %>% 
  arrange(desc(nb_lignes))


# On ne va garder que les onglets qui ne sont pas vides. 
# Les onglets à 2 lignes sont à chaque fois vide (car la colonne n° a été remplie pour 1 et 2) 
# sauf pour 4 onglets particuliers qui sont ici rajoutés.
Onglets_non_empty <- tab_dim %>%
  filter(nb_lignes != 2) %>%
  pull(Onglet) %>% 
  c("ii_3_activ_consult","iii_1_elearning", "i_9_contrats_internationaux","i_1_articles_synth")

# On affiche le tableau (Seulement le top 10)
tab_dim %>% filter(Onglet %in% Onglets_non_empty) %>% 
  slice(1:10)
```

# Exploitation des données

## Premiers indicateurs

### Projets

> NB : Il y a un projet international (le seul) à la fin inconnue... Donc par défaut j'ai décidé la fin en 2024 pour ne pas changer la tête du graphique tout en conservant l'info qu'il y a un projet international.

```{r out.width = "100%", fig.width = 13, fig.height = 10}

## Extraction des projets nationaux
projets_nationaux <- ANX4$i_9_contrats_nationaux %>% 
  clean_names() %>% 
  select(-x11) %>% 
  drop_na(contrat) %>% drop_na(date_debut) %>% mutate(type = "National")

## Projets européens
projets_europ <- ANX4$i_9_contrats_europ_autres %>% drop_na(`Date début`) %>% clean_names() %>%  
  mutate_at(vars(date_debut:date_fin), as.Date) %>% mutate(type = "Européen")

## Projets internationaux
projets_inter <- ANX4$i_9_contrats_internationaux %>% clean_names() %>%  
  mutate_at(vars(date_debut:date_fin), as.Date) %>% mutate(type = "International")

## Projets R&D
projets_rd <- ANX4$i_9_contrats_prive_r_d_indus %>% clean_names() %>%  
  mutate_at(vars(date_debut:date_fin), as.Date) %>% mutate(type = "R&D")

## Projets PIA
projets_pia <- ANX4$i_9_contrats_pia %>% clean_names() %>%  drop_na(contrat,date_debut) %>% 
  mutate_at(vars(date_debut:date_fin), as.Date) %>% mutate(type = "PIA")

## Projets de collectivités territoriales
projets_coll_terri <- ANX4$i_9_contrats_coll_territ %>% clean_names() %>%  drop_na(contrat,date_debut, date_fin) %>% 
  mutate_at(vars(date_debut), as.Date, origin = "1899-12-31") %>% mutate(type = "National")

## On assemble le tout
PRJ <- bind_rows(projets_nationaux,projets_europ)%>%
  bind_rows(projets_inter) %>% 
  bind_rows(projets_rd) %>% 
  bind_rows(projets_pia) %>% 
  bind_rows(projets_coll_terri) %>% 
  mutate_at(vars(porteur:axe_3), replace_cases) %>% unique() %>% 
  mutate(date_fin = replace_na(date_fin, "2024-01-01")) %>%  
  mutate(porteur = recode(porteur, "0" = "ETBX Non porteur", "1"="ETBX Porteur")) %>% 
  mutate(porteur = factor(porteur, levels = c("ETBX Porteur", "ETBX Non porteur"))) %>%
  group_by(contrat) %>% 
  summarise(date_debut = min(date_debut),
         date_fin = max(date_fin),
         porteur = unique(porteur),
         type = unique(type)) %>% 
  ungroup()


## Production du graphique
ggplot(PRJ, aes(x = date_fin, y = reorder(contrat,date_debut))) +
  geom_segment(aes(x = date_debut, xend = date_fin, y = reorder(contrat,date_debut), yend = reorder(contrat,date_debut), color = type), size = 4) +
  geom_point(fill = "black", shape = 23, color = "black", size = 4) +
  geom_point(aes(x = date_debut, y = reorder(contrat,date_debut)), color ="black", fill = "black", shape = 23, size = 4) +
  theme_inrae() +
  geom_vline(xintercept = as.Date("2020-06-01"), color = "blue", size = 4) +
  labs(x = "Temps", y = "Contrats", color = "Type de contrat") +
  facet_wrap(~porteur, scales = "free")
```

Il y a **`r n_distinct(PRJ$contrat)`** projets en cours.

### Production de connaissances

Nous étudions dans un premier temps le nombre d'articles, d'actes de colloques et de chapitres d'ouvrages publiés par des agents de l'unité.

```{r}
acl1 <- ANX4$i_1_articles_sctfq %>%
  clean_names() %>% 
  mutate(year = stringr::str_extract(reference_complete,'\\d{4}')) %>% 
  drop_na(year) %>% 
  group_by(year) %>% 
  summarise(n = n_distinct(reference_complete)) %>% 
  spread(key = year, value = n) %>%
  mutate(Type = "Articles")


acl2 <- ANX4$i_1_autres_articles %>%
  clean_names() %>% 
  mutate(year = stringr::str_extract(reference_complete,'\\d{4}')) %>% 
  filter(year != 2016) %>% 
  drop_na(year) %>% 
  group_by(year) %>% 
  summarise(n = n_distinct(reference_complete)) %>%
  spread(key = year, value = n) %>%
  mutate(Type = "Autres articles")


acl3 <- ANX4$i_3_articles_actes_colloq %>%
  clean_names() %>% 
  mutate(year = stringr::str_extract(reference_complete,'\\d{4}')) %>% 
  drop_na(year) %>% 
  group_by(year) %>% 
  summarise(n = n_distinct(reference_complete)) %>% spread(key = year, value = n) %>% mutate(Type = "Actes colloques")


acl4 <- ANX4$i_2_chap_ouvrages %>%
  clean_names() %>% 
  mutate(year = stringr::str_extract(reference_complete,'\\d{4}')) %>% 
  drop_na(year) %>% 
  group_by(year) %>% 
  summarise(n = n_distinct(reference_complete)) %>% spread(key = year, value = n) %>% mutate(Type = "Chapitres ouvrages")

bind_rows(acl1,acl2,acl3,acl4) %>% 
  select(Type,`2017`:`2020`) 

```

En ce qui concerne les revues, voici un nuage des revues auxquelles sont soumis les articles scientifiques

```{r, width = 10, height = 10, fig.align = "center", out.width = "100%"}
word_count <- ANX4$i_1_articles_sctfq %>% 
  clean_names() %>% 
  group_by(journal) %>% 
  count() %>% arrange(desc(n)) %>% 
  ungroup() %>% 
  rowwise() %>% 
  mutate(n = ifelse(journal == "Journal of Water Resources Planning and Management", yes = 7, no = n)) %>% 
    mutate(journal = ifelse(journal == "Journal of Water Resources Planning and Management", yes = "Water Res. Planning and Management", no = journal)) %>% 
  ungroup() %>%  mutate(journal = str_to_lower(journal)) %>% 
  mutate(journal = str_trim(journal))

# wordcloud2(word_count, size = 0.35)
```

![](wordcloud.png)

Nous pouvons ensuite observer si notre unité est bien identifiée dans les revues dans lesquelles elle publie : 

```{r}

articles <- ANX4$i_1_articles_sctfq %>% 
  clean_names() %>% 
  group_by(journal) %>% 
  count() %>% arrange(desc(n)) %>% 
  mutate(journal = str_to_lower(journal)) %>% 
  mutate(journal = str_trim(journal))



tab_relecture_articles <- ANX4$i_8_evaluation_articles %>% 
  clean_names() %>% 
  select(revue_ouvrage, nombre_de_relectures) %>% 
  mutate(revue_ouvrage = str_to_lower(revue_ouvrage)) %>% 
  mutate(revue_ouvrage = str_trim(revue_ouvrage)) %>% 
  full_join(articles, by = c("revue_ouvrage"="journal")) %>% 
  arrange(revue_ouvrage) %>% unique() %>% group_by(revue_ouvrage) %>% 
  summarise(n_relecture = sum(nombre_de_relectures, na.rm=TRUE), n_publi = sum(n, na.rm=TRUE)) %>% 
  ungroup() %>% 
  unique()

# Top 10
tab_relecture_articles %>%
  mutate(indicateur_som = n_relecture * n_publi) %>% 
  arrange(desc(indicateur_som))%>% 
  slice(1:10) 

# Top 10
tab_relecture_articles %>%
  mutate(indicateur_moy = (n_relecture + n_publi)/2) %>% 
  arrange(desc(indicateur_moy))%>% 
  slice(1:10) 
```

### Partenariats

#### Interdisciplinarité proche (interne)

A partir du tableau rempli par l'équipe du GT4, nous pouvons créer une liste de noms d'auteurs (prenant en compte toutes les syntaxes possibles d'un même nom) appartenant à ETBX.

```{r}
table_auteurs <- readxl::read_excel("data/table_auteurs_ETBX_2020-07-27_SL_DC.xlsx") %>% clean_names()


liste_auteurs_etbx <- table_auteurs %>%
  filter(etbx_oui_non %in% c("oui","temporaire", "oui / BSA", "temporaire ?")) %>% 
  pull(auteur)

liste_auteurs_etbx
```

Chacun des agents ETBX a aussi été affecté à une discipline, en accord avec les informations présentées sur le site web de l'unité [https://www6.bordeaux-aquitaine.inrae.fr/etbx/Les-equipes](https://www6.bordeaux-aquitaine.inrae.fr/etbx/Les-equipes).

Nous pouvons donc quantifier le nombre d'auteurs ETBX pour chaque publication :

```{r}

calcul_nb_copubli <- function(x) {
  liste_auteurs_etbx[str_detect(x,liste_auteurs_etbx)] %>% gsub('^\\.|\\.$', '', .) %>% unique() %>% 
    length()
}

# Top 10
ANX4$i_1_articles_sctfq %>% clean_names() %>% 
  select(reference_complete) %>% 
  rowwise() %>% 
  mutate(nb_copubli = calcul_nb_copubli(reference_complete)) %>% 
  ungroup() %>% arrange(desc(nb_copubli)) %>% 
  slice(1:10) 
```

Nous pouvons maintenant nous intéresser aux disciplines :

```{r}
table_disciplines <- table_auteurs %>% filter(etbx_oui_non %in% c("oui","temporaire", "oui / BSA", "temporaire ?")) %>% 
  select(auteur,discipline) %>% drop_na()


calcul_discipline <- function(x) {
  
  df <- data.frame(auteur = liste_auteurs_etbx[str_detect(x,liste_auteurs_etbx)] %>% gsub('^\\.|\\.$', '', .) %>% unique() )
  
  df %>% inner_join(table_disciplines, by = "auteur") %>% pull(discipline) %>% unique() %>% paste(collapse = " / ")
  
}

# Top 10
ANX4$i_1_articles_sctfq %>% clean_names() %>% 
  select(reference_complete) %>% 
  rowwise() %>% 
  mutate(disciplines = calcul_discipline(reference_complete)) %>% 
  mutate(nb_disciplines = str_split(disciplines, " / ")[[1]] %>% length) %>% 
  ungroup() %>% 
  arrange(desc(nb_disciplines)) %>% 
  slice(1:10) 

```

#### Interdisciplinarité éloignée (externe)

Cette section nécessite de disposer d'informations sur les affiliations des co-auteurs. Cette information n'est malheureusement pas accessible directement via le tableau excel (stratus) rempli par les collègues. 

Il est donc nécessaire de passer soit :

- par HAL-INRAE, ce qui implique de travailler, forcémment, avec un nombre réduit de publications
- A partir de notre tableau excel d'affiliation des agents à ETBX / aux disciplines : Rajouter le max d'info sur les co-publiants externes.

#### Export HAL-INRAE :

J'ai testé un export direct de HAL avec 2 critères :
- Année 2017-2020
- Unité = ETBX

Et j'ai le nombre d'entrées suivant :

```{r}
# J'ai testé un export massif HAL-INRAE avec dates 2017-2020 et structure ETBX
test <- bib2df::bib2df("data/biball.bib")

test %>% group_by(CATEGORY) %>% count()
```


#### Nombre de citations

A partir de export HAL-INRAE, j'ai pu récupérer `r n_distinct(test$DOI)` DOI, que je pourrais utiliser pour récupérer des données du nombre de citations de chaque article via Scopus. 

Il me reste également à explorer l'approche "Publish or Perish" proposée par Baptiste qui se révèlera peut-être plus exhaustive que Scopus.

L'approche google scholar est pour le moment exclue (nécessité pour chaque agent de créer un compte et de me donner un ID trouvable dans les paramètres).

## Vision pour chaque onglet

[TO-DO]
